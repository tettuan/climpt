# Agents Documentation Index

## 設計ドキュメント体系

### 第二世代設計（2025-01 改訂、優先参照）

思考実験（210 観点）を経て再構築した設計。シンプルさと堅牢性を追求。

```
┌─────────────────────────────────────────────────────────────┐
│  10_philosophy.md          ← 設計哲学（変わらない原則）      │
│  三原則: 単純さ、境界、透明性                               │
├─────────────────────────────────────────────────────────────┤
│  11_core_architecture.md   ← コアアーキテクチャ（本質的構造）│
│  四層: 構成層、実行層、判定層、接続層                       │
├─────────────────────────────────────────────────────────────┤
│  12_contracts.md           ← 契約（境界の約束事）            │
│  入力・出力・副作用・エラー                                  │
├─────────────────────────────────────────────────────────────┤
│  13_extension_points.md    ← 拡張ポイント（組み合わせの方法）│
│  設定・プラグイン・複数Agent                                 │
└─────────────────────────────────────────────────────────────┘
```

| ファイル                  | 内容               | 読むタイミング     |
| ------------------------- | ------------------ | ------------------ |
| `10_philosophy.md`        | 設計の根本原則     | 最初に読む         |
| `11_core_architecture.md` | 四層構造と依存関係 | 全体像を掴むとき   |
| `12_contracts.md`         | 各層の入出力契約   | 実装・拡張するとき |
| `13_extension_points.md`  | 拡張方法とパターン | 機能追加するとき   |

### 第一世代設計（参考資料）

第二世代で上書きされた旧設計。互換性確認や経緯理解のために残す。

| ファイル                       | 対応する第二世代            | 状態 |
| ------------------------------ | --------------------------- | ---- |
| `00_abstraction_layers.md`     | → `11_core_architecture.md` | 参考 |
| `04_design_contracts.md`       | → `12_contracts.md`         | 参考 |
| `09_implementation_details.md` | → (実装コード参照)          | 参考 |

### 補助ドキュメント

実装詳細や移行ガイド。第二世代に依存しない独立した資料。

| ファイル                     | 内容                 | 状態 |
| ---------------------------- | -------------------- | ---- |
| `01_architecture.md`         | 旧アーキテクチャ概要 | 参考 |
| `02_agent_definition.md`     | agent.json の詳細    | 有効 |
| `03_runner.md`               | Runner 実装詳細      | 有効 |
| `05_prompt_system.md`        | プロンプト解決       | 有効 |
| `06_action_system.md`        | アクション処理       | 有効 |
| `07_config_system.md`        | 設定システム         | 有効 |
| `08_implementation_guide.md` | 実装ガイド           | 有効 |
| `step_flow_design.md`        | StepMachine 参考設計 | 参考 |
| `migration_*.md`             | 移行ガイド           | 有効 |

## 思考実験の記録

設計の穴を発見するための思考実験。合計 222 の設計観点を発見。

| 実験           | 焦点               | 発見数 | 累計 |
| -------------- | ------------------ | ------ | ---- |
| `tmp/gecko/`   | 基本ループ         | 26     | 26   |
| `tmp/rudder/`  | ステップ遷移       | 38     | 64   |
| `tmp/saucier/` | 並列実行（除外）   | 46     | 110  |
| `tmp/welder/`  | 複数インスタンス   | 100    | 210  |
| `tmp/tailor/`  | ステップ間引き継ぎ | 12     | 222  |

**重要な発見**:

- 並列実行は Agent の責務外（複数インスタンス起動で対応）
- Issue = Branch = Worktree = Instance の 1:1:1:1 対応
- 派生元から worktree 作成 → 派生元へマージ（最もシンプル）
- 派生元は必須（暗黙のデフォルトなし）

**Tailor の発見** (ステップ間引き継ぎ):

- StepContext でステップ出力を蓄積・引き継ぎ
- 名前空間（stepId.key）で同名出力の衝突を防止
- OutputExtractor で LLM 応答から構造化データを抽出
- 入力仕様（InputSpec）で依存関係を明示的に宣言

## 読み方ガイド

### 新規参加者

```
10_philosophy.md → 11_core_architecture.md → 02_agent_definition.md
```

### 実装者

```
12_contracts.md → 03_runner.md → 実装コード
```

### 拡張者

```
13_extension_points.md → 12_contracts.md → 実装コード
```

### 設計レビュアー

```
10_philosophy.md → tmp/*/DESIGN_GAPS.md → 12_contracts.md
```

## 設計原則（10 から抜粋）

1. **単純さの原則**: 複雑さは分割で解決する。Agent 自体を複雑にしない。
2. **境界の原則**: Agent の責務は明確な境界内に収める。境界外は委譲する。
3. **透明性の原則**: 状態と副作用を明示する。暗黙の振る舞いを排除する。

## 禁止事項（10 から抜粋）

- Agent 内並列実行
- リソースロック
- デッドロック検出
- 複雑なブランチ戦略
- 暗黙のデフォルト
