# コアアーキテクチャ

Agent システムの本質的な構造。すべての実装はこの構造に従う。

## 全体像

```
┌─────────────────────────────────────────────────────────────────┐
│                         Agent                                   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 構成層 (Configuration)                                   │   │
│  │ 「何を実行するか」を定義                                  │   │
│  └───────────────────────────┬─────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 実行層 (Execution)                                       │   │
│  │ 「ループを回す」を担当                                    │   │
│  │                                                         │   │
│  │    ┌─────────────────────────────────────────────┐      │   │
│  │    │ while (!complete) {                         │      │   │
│  │    │   prompt = resolve()     ←─┐               │      │   │
│  │    │   response = query()       │ 接続層        │      │   │
│  │    │   complete = judge()     ←─┘               │      │   │
│  │    │ }                                           │      │   │
│  │    └─────────────────────────────────────────────┘      │   │
│  │                              │                          │   │
│  │                              ▼                          │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │ 判定層 (Judgment)                               │   │   │
│  │  │ 「完了・遷移」を判断                             │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 接続層          │
                    │ (Connection)    │
                    │ - LLM API       │
                    │ - ファイル      │
                    │ - 外部サービス  │
                    └─────────────────┘
```

## 四層構造

### 1. 構成層 (Configuration)

**責務**: 実行に必要なすべてを準備する

```
入力                         出力
─────                        ─────
agent.json          →        AgentDefinition
steps_registry.json →        StepsRegistry
prompts/            →        PromptSet
config.json         →        RuntimeConfig
```

**特性**:

- 実行前に完結する（実行中に構成は変わらない）
- バリデーションはここで完了する
- 不正な構成は起動しない

### 2. 実行層 (Execution)

**責務**: ループを制御する

```typescript
interface Execution {
  run(context: Context): Promise<Result>;
}
```

**特性**:

- 状態遷移: `準備 → 実行中 → 完了`（一方向）
- イテレーション管理: カウント、サマリー蓄積
- 引き継ぎ: 前イテレーションの情報を次に渡す (carry)

### 3. 判定層 (Judgment)

**責務**: 完了とステップ遷移を判断する

```
判定の種類
─────────
完了判定 (Completion)   - Agent 全体の終了条件
遷移判定 (StepCheck)    - ステップ間の移動条件
```

**特性**:

- 純粋な判定ロジック（副作用なし）
- 判定結果は実行層に返す（実行層が状態を更新）

### 4. 接続層 (Connection)

**責務**: 外部システムと接続する

```
接続先
──────
LLM API     - Claude Agent SDK 経由
ファイル    - プロンプト、ログ、設定
外部API     - Webhook、通知（将来）
```

**特性**:

- Agent の境界を超える唯一の層
- 失敗はリカバリ可能（リトライ、フォールバック）
- 外部の都合で Agent を変えない（アダプターパターン）

## 依存関係

```
構成層
  │
  │ 読み込み結果を渡す
  ▼
実行層 ◄───── 判定層
  │              │
  │ 外部呼び出し │ プロンプト解決
  ▼              ▼
接続層 ◄─────────┘
```

**依存の方向**:

- 上位層 → 下位層（許可）
- 下位層 → 上位層（禁止）
- 同一層 → 同一層（許可、ただし循環禁止）

## 実装マッピング

| 層   | 現在の実装                           |
| ---- | ------------------------------------ |
| 構成 | `loader.ts`, `builder.ts`            |
| 実行 | `runner.ts`, `AgentRunner.runLoop()` |
| 判定 | `completion/`, StepMachine           |
| 接続 | SDK Bridge, PromptResolver           |

| コンポーネント  | 実装（予定）          |
| --------------- | --------------------- |
| StepContext     | `step-context.ts`     |
| OutputExtractor | `output-extractor.ts` |
| OutputValidator | `output-validator.ts` |

## 状態管理

### Agent 状態

```
Created → Started → Running → Stopped
            │
            └─ 一方向遷移（戻らない）
```

### ループ状態

```typescript
interface LoopState {
  iteration: number; // 現在のイテレーション
  stepId: string; // 現在のステップ
  carry: Carry; // 引き継ぎデータ
  summaries: Summary[]; // 履歴
}
```

### 状態の所在

| 状態          | 所在          | 更新タイミング          |
| ------------- | ------------- | ----------------------- |
| Agent 状態    | Execution 層  | start/stop 時           |
| ループ状態    | Execution 層  | 各イテレーション終了時  |
| 完了フラグ    | Judgment 層   | check() 呼び出し時      |
| ステップ位置  | Judgment 層   | transition() 呼び出し時 |
| セッション ID | Connection 層 | query() 応答受信時      |
| ステップ出力  | Execution 層  | 各ステップ完了時        |

## ステップ間データ引き継ぎ

### StepContext

ステップの出力を蓄積し、後続ステップに引き継ぐ仕組み。

```
┌─────────────────────────────────────────────────────────────┐
│ StepContext                                                 │
│                                                             │
│  outputs: {                                                 │
│    "measure": { "height": 175, "chest": 95 },              │
│    "fabric":  { "code": "WL-001", "price": 15000 },        │
│    "style":   { "code": "SGL-2B", "base_price": 50000 }    │
│  }                                                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ get("measure", "height") → 175                      │   │
│  │ toUvVariables(inputs)    → { "uv-height": "175" }   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### データフロー

```
Step A              Step B              Step C
  │                   │                   │
  ▼                   ▼                   ▼
┌─────┐           ┌─────┐           ┌─────┐
│ LLM │           │ LLM │           │ LLM │
└──┬──┘           └──┬──┘           └──┬──┘
   │                 │                 │
   ▼                 ▼                 ▼
┌─────┐           ┌─────┐           ┌─────┐
│抽出 │           │抽出 │           │抽出 │
└──┬──┘           └──┬──┘           └──┬──┘
   │                 │                 │
   ▼                 ▼                 ▼
┌─────────────────────────────────────────┐
│            StepContext                   │
│  A.out ──────→ B.in                     │
│  A.out, B.out ─────→ C.in               │
└─────────────────────────────────────────┘
```

### 出力抽出

LLM 応答から構造化データを抽出する。

````
LLM 応答:
┌─────────────────────────────────────────┐
│ 採寸結果です。                           │
│                                         │
│ ```json                                 │
│ {                                       │
│   "height": 175,                        │
│   "chest": 95,                          │
│   "shoulder": 44                        │
│ }                                       │
│ ```                                     │
└─────────────────────────────────────────┘
            │
            ▼ OutputExtractor
┌─────────────────────────────────────────┐
│ { "height": 175, "chest": 95, ... }     │
└─────────────────────────────────────────┘
````

### 名前空間

同名出力の衝突を防ぐため、ステップ ID をプレフィックスとする。

```
ステップ出力          UV 変数名
───────────          ──────────
measure.height   →   uv-measure_height
fabric.price     →   uv-fabric_price
style.price      →   uv-style_price    （衝突しない）
```

## エラーハンドリング

### エラーの分類

```
回復可能 (Recoverable)
├─ 接続タイムアウト    → リトライ
├─ レート制限          → 待機後リトライ
└─ ファイル未発見      → フォールバック

回復不能 (Fatal)
├─ 構成エラー          → 起動中止
├─ スキーマ違反        → 起動中止
└─ ハード上限超過      → 強制停止
```

### エラー伝播

```
接続層でエラー発生
     │
     ▼
回復可能？ ─Yes→ リトライ/フォールバック
     │
    No
     │
     ▼
実行層に伝播
     │
     ▼
ログ出力 + Result.error に記録
     │
     ▼
Agent 停止
```

## 複数 Agent

### 前提

Agent 自体は単一ループ。並列化は「複数 Agent 起動」で実現。

### 外部オーケストレーター

```
┌─────────────────────────────────────────────────────┐
│ Orchestrator (Agent 外)                             │
│                                                     │
│ 1. Issue/Project から作業一覧取得                   │
│ 2. 各作業に対して Agent インスタンス起動             │
│ 3. 完了待機                                         │
│ 4. 結果集約                                         │
│ 5. PR 作成・マージ                                  │
└──────────────────┬──────────────────────────────────┘
                   │
     ┌─────────────┼─────────────┐
     ▼             ▼             ▼
┌─────────┐  ┌─────────┐  ┌─────────┐
│ Agent A │  │ Agent B │  │ Agent C │
│ issue-1 │  │ issue-2 │  │ issue-3 │
└─────────┘  └─────────┘  └─────────┘
```

### 分離の原則

```
1 Issue = 1 Branch = 1 Worktree = 1 Agent Instance

Issue #123
  └── branch: feature/issue-123
        └── worktree: .worktrees/issue-123/
              └── Agent instance: agent-123
```

同じブランチで複数 Agent は動かない。

## 設計判断の記録

### 採用したもの

| 判断                   | 理由                   |
| ---------------------- | ---------------------- |
| 四層構造               | 責務が明確、依存が単純 |
| 単一ループ             | 複雑さを外に追い出す   |
| 外部オーケストレーター | Agent の単純さを維持   |
| 1:1:1:1 マッピング     | 競合を原理的に排除     |

### 採用しなかったもの

| 判断               | 理由                     |
| ------------------ | ------------------------ |
| Agent 内並列実行   | 複雑すぎる               |
| リソースロック     | デッドロックリスク       |
| 複雑なブランチ戦略 | 「派生元へマージ」で十分 |
| 暗黙のデフォルト   | 必須項目は明示的に要求   |
