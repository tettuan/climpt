{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/tettuan/climpt/main/agents/schemas/steps_registry.schema.json",
  "title": "Climpt Steps Registry v2",
  "description": "Schema for step flow definitions with structured gate routing (v2)",
  "type": "object",
  "required": ["agentId", "version", "c1", "steps"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema URL for validation"
    },
    "agentId": {
      "type": "string",
      "description": "Agent identifier (e.g., 'iterator', 'reviewer')"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver format)"
    },
    "c1": {
      "type": "string",
      "description": "C3L path component: c1 (e.g., 'steps')"
    },
    "userPromptsBase": {
      "type": "string",
      "description": "Base directory for user prompts (default: '.agent/{agentId}/prompts')"
    },
    "schemasBase": {
      "type": "string",
      "description": "Base directory for schema files (default: '.agent/{agentId}/schemas')"
    },
    "pathTemplate": {
      "type": "string",
      "description": "Path template with adaptation: '{c1}/{c2}/{c3}/f_{edition}_{adaptation}.md'"
    },
    "pathTemplateNoAdaptation": {
      "type": "string",
      "description": "Path template without adaptation: '{c1}/{c2}/{c3}/f_{edition}.md'"
    },
    "entryStep": {
      "type": "string",
      "description": "Default entry step ID for starting execution"
    },
    "entryStepMapping": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "description": "Mode-based entry step mapping (e.g., { 'issue': 'initial.issue' })"
    },
    "completionPatterns": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/CompletionPattern"
      },
      "description": "Named patterns for failure scenarios"
    },
    "validators": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Validator"
      },
      "description": "Named validators for completion checks"
    },
    "completionSteps": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/CompletionStep"
      },
      "description": "Step definitions for completion validation"
    },
    "steps": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/StepDefinition"
      },
      "description": "Map of step ID to step definition"
    }
  },
  "definitions": {
    "StepDefinition": {
      "type": "object",
      "required": ["stepId", "name", "c2", "c3", "fallbackKey"],
      "properties": {
        "stepId": {
          "type": "string",
          "description": "Unique step identifier (e.g., 'initial.issue')"
        },
        "name": {
          "type": "string",
          "description": "Human-readable step name"
        },
        "type": {
          "type": "string",
          "enum": ["prompt"],
          "default": "prompt",
          "description": "Step type for categorization"
        },
        "stepKind": {
          "type": "string",
          "enum": ["work", "verification", "closure"],
          "description": "Step kind for flow taxonomy. Determines allowed intents: work (next/repeat/jump/handoff), verification (next/repeat/jump/escalate), closure (closing/repeat)"
        },
        "c2": {
          "type": "string",
          "description": "C3L Category (e.g., 'initial', 'continuation')"
        },
        "c3": {
          "type": "string",
          "description": "C3L Classification (e.g., 'issue', 'project')"
        },
        "edition": {
          "type": "string",
          "default": "default",
          "description": "Edition variant (f_{edition}.md)"
        },
        "adaptation": {
          "type": "string",
          "description": "Adaptation variant (f_{edition}_{adaptation}.md)"
        },
        "fallbackKey": {
          "type": "string",
          "description": "Key for fallback prompt in embedded prompts"
        },
        "uvVariables": {
          "type": "array",
          "items": { "type": "string" },
          "description": "User variable names required by this prompt"
        },
        "usesStdin": {
          "type": "boolean",
          "default": false,
          "description": "Whether this step accepts stdin input"
        },
        "outputSchemaRef": {
          "$ref": "#/definitions/OutputSchemaRef",
          "description": "Reference to external JSON Schema for structured output"
        },
        "structuredGate": {
          "$ref": "#/definitions/StructuredGate",
          "description": "Structured gate configuration for intent/target routing"
        },
        "transitions": {
          "$ref": "#/definitions/Transitions",
          "description": "Intent to step transition mapping"
        },
        "description": {
          "type": "string",
          "description": "Optional description of what this step does"
        },
        "model": {
          "type": "string",
          "enum": ["sonnet", "opus", "haiku"],
          "description": "Model to use for this step. Resolution order: step.model > runner.flow.defaultModel > 'opus' (system default). Use haiku for cost optimization on routine steps."
        }
      }
    },
    "CompletionStep": {
      "type": "object",
      "required": ["stepId", "name", "c2", "c3"],
      "properties": {
        "stepId": {
          "type": "string",
          "description": "Completion step identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "c2": {
          "type": "string",
          "description": "C3L Category"
        },
        "c3": {
          "type": "string",
          "description": "C3L Classification"
        },
        "completionConditions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/CompletionCondition"
          },
          "description": "Conditions that must pass for completion"
        },
        "onFailure": {
          "$ref": "#/definitions/FailureAction",
          "description": "Action when completion fails"
        },
        "outputSchemaRef": {
          "$ref": "#/definitions/OutputSchemaRef",
          "description": "Reference to output schema"
        },
        "description": {
          "type": "string",
          "description": "Step description"
        }
      }
    },
    "OutputSchemaRef": {
      "type": "object",
      "required": ["file", "schema"],
      "properties": {
        "file": {
          "type": "string",
          "description": "Schema file name (relative to schemasBase)"
        },
        "schema": {
          "type": "string",
          "description": "Schema name within the file"
        }
      }
    },
    "StructuredGate": {
      "type": "object",
      "required": ["allowedIntents", "intentSchemaRef", "intentField"],
      "properties": {
        "allowedIntents": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "next",
              "repeat",
              "jump",
              "closing",
              "abort",
              "escalate",
              "handoff"
            ]
          },
          "description": "List of intents this step can emit. Allowed values depend on stepKind: work (next/repeat/jump/handoff), verification (next/repeat/jump/escalate), closure (closing/repeat)"
        },
        "intentSchemaRef": {
          "type": "string",
          "pattern": "^#/",
          "description": "Internal JSON Pointer to intent enum in step schema (must start with '#/'). Example: '#/properties/next_action/properties/action'. External file references are NOT allowed - use $ref in step schema to share definitions. Required per 08_step_flow_design.md Section 4."
        },
        "intentField": {
          "type": "string",
          "description": "JSON path to extract intent from structured output (e.g., 'next_action.action')"
        },
        "targetField": {
          "type": "string",
          "description": "JSON path to extract target step ID for jump intent (e.g., 'next_action.details.target')"
        },
        "handoffFields": {
          "type": "array",
          "items": { "type": "string" },
          "description": "JSON paths to extract for handoff data (e.g., ['analysis.understanding', 'issue'])"
        },
        "targetMode": {
          "type": "string",
          "enum": ["explicit", "dynamic", "conditional"],
          "default": "explicit",
          "description": "How target step IDs are determined"
        },
        "failFast": {
          "type": "boolean",
          "default": true,
          "description": "When true (default), throw error instead of using fallback if intent cannot be determined. Required for production agents per design/08_step_flow_design.md Section 4/6. Set to false only for debugging."
        },
        "fallbackIntent": {
          "type": "string",
          "description": "Default intent if response parsing fails. Ignored when failFast is true."
        }
      }
    },
    "Transitions": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/TransitionRule"
      },
      "description": "Map of intent to transition rule"
    },
    "TransitionRule": {
      "type": "object",
      "oneOf": [
        {
          "required": ["target"],
          "properties": {
            "target": {
              "type": "string",
              "description": "Target step ID"
            },
            "fallback": {
              "type": "string",
              "description": "Fallback step if target fails"
            }
          }
        },
        {
          "required": ["condition", "targets"],
          "properties": {
            "condition": {
              "type": "string",
              "description": "Condition expression or variable name"
            },
            "targets": {
              "type": "object",
              "additionalProperties": { "type": "string" },
              "description": "Map of condition values to target step IDs"
            }
          }
        }
      ]
    },
    "CompletionPattern": {
      "type": "object",
      "required": ["description", "edition"],
      "properties": {
        "description": {
          "type": "string",
          "description": "Human-readable pattern description"
        },
        "edition": {
          "type": "string",
          "description": "Edition for failure prompt"
        },
        "adaptation": {
          "type": "string",
          "description": "Adaptation for failure prompt"
        },
        "params": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Parameters extracted on match"
        }
      }
    },
    "Validator": {
      "type": "object",
      "required": ["type", "command", "successWhen", "failurePattern"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["command"],
          "description": "Validator type"
        },
        "command": {
          "type": "string",
          "description": "Command to execute"
        },
        "successWhen": {
          "type": "string",
          "description": "Success condition (e.g., 'empty', 'exitCode:0')"
        },
        "failurePattern": {
          "type": "string",
          "description": "Reference to completion pattern on failure"
        },
        "extractParams": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Parameter extraction rules"
        }
      }
    },
    "CompletionCondition": {
      "type": "object",
      "required": ["validator"],
      "properties": {
        "validator": {
          "type": "string",
          "description": "Reference to named validator"
        }
      }
    },
    "FailureAction": {
      "type": "object",
      "required": ["action"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["retry", "abort", "skip"],
          "description": "Action to take on failure"
        },
        "maxAttempts": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum retry attempts"
        }
      }
    }
  }
}
