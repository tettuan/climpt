{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/tettuan/climpt/main/agents/schemas/agent.schema.json",
  "title": "Climpt Agent Definition",
  "description": "Schema for climpt-agents agent definition files",
  "type": "object",
  "required": [
    "version",
    "name",
    "displayName",
    "description",
    "runner"
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema URL for validation"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver format)"
    },
    "name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Agent identifier (lowercase kebab-case)"
    },
    "displayName": {
      "type": "string",
      "description": "Human-readable name"
    },
    "description": {
      "type": "string",
      "description": "Agent description"
    },
    "parameters": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/ParameterDefinition"
      },
      "description": "CLI parameters the agent accepts"
    },
    "runner": {
      "$ref": "#/definitions/RunnerConfig"
    }
  },
  "additionalProperties": false,
  "definitions": {
    "RunnerConfig": {
      "type": "object",
      "required": [
        "flow",
        "completion",
        "boundaries"
      ],
      "properties": {
        "flow": {
          "$ref": "#/definitions/RunnerFlowConfig"
        },
        "completion": {
          "$ref": "#/definitions/RunnerCompletionConfig"
        },
        "boundaries": {
          "$ref": "#/definitions/RunnerBoundariesConfig"
        },
        "integrations": {
          "$ref": "#/definitions/RunnerIntegrationsConfig"
        },
        "actions": {
          "$ref": "#/definitions/ActionConfig"
        },
        "execution": {
          "$ref": "#/definitions/RunnerExecutionConfig"
        },
        "logging": {
          "$ref": "#/definitions/LoggingConfig"
        }
      },
      "additionalProperties": false
    },
    "RunnerFlowConfig": {
      "type": "object",
      "required": ["systemPromptPath", "prompts"],
      "properties": {
        "systemPromptPath": {
          "type": "string",
          "description": "Path to system prompt (relative to .agent/{name}/)"
        },
        "prompts": {
          "type": "object",
          "required": ["registry", "fallbackDir"],
          "properties": {
            "registry": {
              "type": "string",
              "description": "Path to steps registry JSON"
            },
            "fallbackDir": {
              "type": "string",
              "description": "Fallback directory for prompts"
            }
          }
        },
        "schemas": {
          "type": "object",
          "properties": {
            "base": {
              "type": "string",
              "description": "Base directory for JSON schemas"
            },
            "inspection": {
              "type": "boolean",
              "description": "Enable schema inspection mode"
            }
          }
        },
        "defaultModel": {
          "type": "string",
          "enum": ["sonnet", "opus", "haiku"],
          "description": "Default model for all steps. Resolution order: step.model > runner.flow.defaultModel > 'opus' (system default)."
        },
        "askUserAutoResponse": {
          "type": "string",
          "description": "Auto-response message for AskUserQuestion tool. When set, the agent will automatically respond with this message instead of waiting for user input, enabling autonomous execution."
        }
      },
      "additionalProperties": false
    },
    "RunnerCompletionConfig": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "externalState",
            "iterationBudget",
            "checkBudget",
            "keywordSignal",
            "structuredSignal",
            "stepMachine",
            "composite",
            "custom"
          ],
          "description": "How the agent determines completion. Types: externalState (external resource state), iterationBudget (N iterations), checkBudget (N checks), keywordSignal (keyword output), structuredSignal (JSON output), stepMachine (step state machine), composite (combined conditions), custom (external handler)."
        },
        "config": {
          "type": "object",
          "description": "Configuration for the completion type",
          "properties": {
            "maxIterations": {
              "type": "number",
              "minimum": 1,
              "description": "Maximum iterations (for iterationBudget type)"
            },
            "completionKeyword": {
              "type": "string",
              "description": "Keyword to signal completion (for keywordSignal type)"
            },
            "handlerPath": {
              "type": "string",
              "description": "Path to custom handler (for custom type)"
            },
            "maxChecks": {
              "type": "number",
              "minimum": 1,
              "description": "Maximum status checks (for checkBudget type)"
            },
            "resourceType": {
              "type": "string",
              "enum": ["github-issue", "github-project", "file", "api"],
              "description": "Resource type being monitored (for externalState type)"
            },
            "targetState": {
              "description": "Target state to match (for externalState type)"
            },
            "operator": {
              "type": "string",
              "enum": ["and", "or", "first"],
              "description": "Logical operator for combining conditions (for composite type)"
            },
            "conditions": {
              "type": "array",
              "description": "Array of completion conditions (for composite type)",
              "items": {
                "type": "object",
                "properties": {
                  "type": {
                    "type": "string",
                    "description": "Completion type for this condition"
                  },
                  "config": {
                    "type": "object",
                    "description": "Configuration for this condition"
                  }
                },
                "required": ["type", "config"]
              }
            },
            "signalType": {
              "type": "string",
              "description": "Action block type to detect (for structuredSignal type)"
            },
            "requiredFields": {
              "type": "object",
              "description": "Required field values to match (for structuredSignal type)"
            },
            "registryPath": {
              "type": "string",
              "description": "Path to steps registry (for stepMachine type)"
            },
            "entryStep": {
              "type": "string",
              "description": "Entry step ID (for stepMachine type)"
            }
          }
        }
      },
      "additionalProperties": false
    },
    "RunnerBoundariesConfig": {
      "type": "object",
      "required": ["allowedTools", "permissionMode"],
      "properties": {
        "allowedTools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Tools the agent is allowed to use"
        },
        "permissionMode": {
          "type": "string",
          "enum": ["default", "plan", "acceptEdits", "bypassPermissions"],
          "description": "Claude permission mode"
        },
        "sandbox": {
          "$ref": "#/definitions/SandboxConfig",
          "description": "Fine-grained sandbox configuration"
        }
      },
      "additionalProperties": false
    },
    "RunnerIntegrationsConfig": {
      "type": "object",
      "properties": {
        "github": {
          "$ref": "#/definitions/GitHubConfig"
        }
      },
      "additionalProperties": false
    },
    "RunnerExecutionConfig": {
      "type": "object",
      "properties": {
        "worktree": {
          "$ref": "#/definitions/WorktreeConfig"
        },
        "finalize": {
          "$ref": "#/definitions/FinalizeConfig"
        }
      },
      "additionalProperties": false
    },
    "SandboxConfig": {
      "type": "object",
      "description": "Sandbox configuration for controlled access",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable sandbox mode"
        },
        "network": {
          "type": "object",
          "properties": {
            "mode": {
              "type": "string",
              "enum": ["trusted", "none", "custom"],
              "default": "trusted",
              "description": "Network access mode: trusted (pre-approved domains), none (no network), custom (user-defined)"
            },
            "trustedDomains": {
              "type": "array",
              "items": { "type": "string" },
              "description": "List of allowed domains (supports wildcards like *.github.com)"
            }
          }
        },
        "filesystem": {
          "type": "object",
          "properties": {
            "allowedPaths": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Additional paths to allow write access"
            }
          }
        }
      }
    },
    "ParameterDefinition": {
      "type": "object",
      "required": ["type", "description", "cli"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "array"],
          "description": "Parameter type"
        },
        "description": {
          "type": "string",
          "description": "Parameter description"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether the parameter is required (default: false)"
        },
        "default": {
          "description": "Default value"
        },
        "cli": {
          "type": "string",
          "pattern": "^--[a-z][a-z0-9-]*$",
          "description": "CLI flag (e.g., '--topic')"
        },
        "validation": {
          "type": "object",
          "properties": {
            "min": {
              "type": "number",
              "description": "Minimum value (for numbers)"
            },
            "max": {
              "type": "number",
              "description": "Maximum value (for numbers)"
            },
            "pattern": {
              "type": "string",
              "description": "Regex pattern (for strings)"
            },
            "enum": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Allowed values"
            }
          }
        }
      }
    },
    "ActionConfig": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable action detection and execution"
        },
        "types": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Allowed action types"
        },
        "outputFormat": {
          "type": "string",
          "description": "Markdown code block marker format"
        },
        "handlers": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Handler mapping (type -> handler spec)"
        }
      }
    },
    "GitHubConfig": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable GitHub integration"
        },
        "labels": {
          "type": "object",
          "properties": {
            "requirements": {
              "type": "string",
              "description": "Label for requirements documentation"
            },
            "inProgress": {
              "type": "string",
              "description": "Label for in-progress state"
            },
            "blocked": {
              "type": "string",
              "description": "Label for blocked state"
            },
            "completion": {
              "type": "object",
              "description": "Labels to apply on issue completion",
              "properties": {
                "add": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "Labels to add on completion"
                },
                "remove": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "Labels to remove on completion"
                }
              }
            }
          },
          "additionalProperties": {
            "type": "string"
          },
          "description": "Label mappings"
        },
        "defaultClosureAction": {
          "type": "string",
          "enum": ["close", "label-only", "label-and-close"],
          "default": "close",
          "description": "Default action for issue closure: close (close issue), label-only (change labels only, keep open), label-and-close (change labels then close)"
        }
      }
    },
    "WorktreeConfig": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable git worktree"
        },
        "root": {
          "type": "string",
          "description": "Worktree root directory"
        }
      }
    },
    "FinalizeConfig": {
      "type": "object",
      "properties": {
        "autoMerge": {
          "type": "boolean",
          "default": true,
          "description": "Whether to automatically merge worktree branch to base"
        },
        "push": {
          "type": "boolean",
          "default": false,
          "description": "Whether to push after merge"
        },
        "remote": {
          "type": "string",
          "default": "origin",
          "description": "Remote to push to"
        },
        "createPr": {
          "type": "boolean",
          "default": false,
          "description": "Whether to create a PR instead of direct merge"
        },
        "prTarget": {
          "type": "string",
          "description": "Target branch for PR"
        }
      }
    },
    "LoggingConfig": {
      "type": "object",
      "required": ["directory", "format"],
      "properties": {
        "directory": {
          "type": "string",
          "description": "Log directory path"
        },
        "format": {
          "type": "string",
          "enum": ["jsonl", "text"],
          "description": "Log format"
        },
        "maxFiles": {
          "type": "number",
          "minimum": 1,
          "description": "Maximum number of log files to keep"
        }
      }
    }
  }
}
