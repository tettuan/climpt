# Agents ルール

## 基本方針

Agent の実行は **Agent 自身の動作検証** が目的である。

## 原則

1. **Agent が完遂する**
   - Agent に依頼したタスクは、Agent 自身が最後まで完了させる
   - 人間が手動でリカバリーしない

2. **エラーは Agent を修正して対処する**
   - Agent の不具合やエラーが発生した場合、手動で回避しない
   - Agent のコードを修正し、Agent 自身で対処できるようにする

## 対処方法

### 調査の原則

**sub-agent に委譲する**

- 調査タスクは Task tool で sub-agent を起動して実行する
- 自身のコンテキストを消費せず、結果のみ受け取る
- 複数の調査は並列実行し、待ち時間を短縮する

**ログを読む、推測しない**

- `tmp/logs/` のセッションログで step 単位の実行履歴を確認
- Agent の思考（assistant）と実行結果（tool_result）の乖離を見る

**再現可能な状態を作る**

- 同一入力で再実行し、同じエラーが出るか確認
- 再現しなければ外部状態（API、ファイル）の変化を疑う

### 問題の捉え方

**「意図」と「結果」のギャップを特定する**

1. Agent は何をしようとしたか
2. 実際に何が起きたか
3. なぜ乖離したか

**原因の分類**

| 分類           | 問い                               |
| -------------- | ---------------------------------- |
| プロンプト不足 | 判断に必要な情報を与えたか？       |
| 制約の欠如     | やってはいけないことを明示したか？ |
| ツール設計     | Agent に適切なツールを渡したか？   |
| 環境依存       | 権限・外部サービスの制限はないか？ |

### Agent ならではの修正

**コードで自律性を担保する**

- 失敗時のフォールバック動作を定義する
- リトライ条件と上限を設定する
- 完了条件を Agent 自身が判定できるようにする

**プロンプトで境界を定める**

- 許可するアクションを列挙する
- 出力フォーマットを厳密に定義する
- 禁止事項を具体的に記述する

**検証を自動化する**

- Agent の出力を schema でバリデーションする
- 実行前に前提条件をチェックする

## 禁止事項

- Agent のエラーを手動でリカバリーすること
- Agent が失敗したタスクを人間が代わりに完了させること
