{
  "agentId": "reviewer",
  "version": "3.0.0",
  "userPromptsBase": ".agent/reviewer/prompts",
  "schemasBase": ".agent/reviewer/schemas",
  "c1": "steps",
  "pathTemplate": "{c1}/{c2}/{c3}/f_{edition}_{adaptation}.md",
  "pathTemplateNoAdaptation": "{c1}/{c2}/{c3}/f_{edition}.md",

  "entryStepMapping": {
    "issue": "initial.issue",
    "externalState": "initial.issue",
    "iterate": "initial.default"
  },

  "completionPatterns": {
    "git-dirty": {
      "description": "未コミットの変更がある",
      "edition": "failed",
      "adaptation": "git-dirty",
      "params": ["changedFiles", "untrackedFiles"]
    },
    "branch-not-pushed": {
      "description": "ブランチがリモートにプッシュされていない",
      "edition": "failed",
      "adaptation": "branch-not-pushed",
      "params": ["branchName", "remoteStatus"]
    },
    "branch-not-merged": {
      "description": "ブランチがマージされていない",
      "edition": "failed",
      "adaptation": "branch-not-merged",
      "params": ["branchName", "baseBranch", "mergeStatus"]
    }
  },

  "validators": {
    "git-clean": {
      "type": "command",
      "command": "git status --porcelain",
      "successWhen": "empty",
      "failurePattern": "git-dirty",
      "extractParams": {
        "changedFiles": "parseChangedFiles",
        "untrackedFiles": "parseUntrackedFiles"
      }
    },
    "branch-pushed": {
      "type": "command",
      "command": "git rev-parse --abbrev-ref --symbolic-full-name @{u}",
      "successWhen": "exitCode:0",
      "failurePattern": "branch-not-pushed",
      "extractParams": {
        "branchName": "parseBranchName",
        "remoteStatus": "parseRemoteStatus"
      }
    },
    "branch-merged": {
      "type": "command",
      "command": "git log origin/develop..HEAD --oneline",
      "successWhen": "empty",
      "failurePattern": "branch-not-merged",
      "extractParams": {
        "branchName": "parseBranchName",
        "baseBranch": "stdout",
        "mergeStatus": "parseMergeStatus"
      }
    }
  },

  "completionSteps": {
    "complete.review": {
      "stepId": "complete.review",
      "name": "Review Completion Validation",
      "c2": "retry",
      "c3": "review",
      "completionConditions": [
        { "validator": "git-clean" },
        { "validator": "branch-pushed" },
        { "validator": "branch-merged" }
      ],
      "onFailure": {
        "action": "retry",
        "maxAttempts": 3
      },
      "description": "Validate review completion with git-clean, branch-pushed, branch-merged"
    }
  },

  "steps": {
    "initial.issue": {
      "stepId": "initial.issue",
      "name": "Issue Review Prompt",
      "c2": "initial",
      "c3": "issue",
      "edition": "default",
      "fallbackKey": "initial_issue",
      "uvVariables": ["issue"],
      "usesStdin": false,
      "description": "Initial prompt for reviewing a specific GitHub Issue",
      "condition": "args.issue !== undefined",
      "priority": 10,
      "structuredGate": {
        "allowedIntents": ["next", "repeat", "complete"],
        "intentField": "next_action.action",
        "fallbackIntent": "next",
        "handoffFields": ["review.findings", "review.recommendations"]
      },
      "transitions": {
        "next": { "target": "continuation.issue" },
        "repeat": { "target": "initial.issue" },
        "complete": { "target": "complete.review" }
      }
    },
    "continuation.issue": {
      "stepId": "continuation.issue",
      "name": "Issue Review Continuation",
      "c2": "continuation",
      "c3": "issue",
      "edition": "default",
      "fallbackKey": "continuation_issue",
      "uvVariables": ["issue", "completed_iterations"],
      "usesStdin": false,
      "description": "Continuation prompt for issue review iterations",
      "structuredGate": {
        "allowedIntents": ["next", "repeat", "complete"],
        "intentField": "next_action.action",
        "fallbackIntent": "next",
        "handoffFields": ["review.findings", "review.recommendations"]
      },
      "transitions": {
        "next": { "target": "continuation.issue" },
        "repeat": { "target": "continuation.issue" },
        "complete": { "target": "complete.review" }
      }
    },
    "initial.default": {
      "stepId": "initial.default",
      "name": "Initial Review Prompt",
      "c2": "initial",
      "c3": "default",
      "edition": "default",
      "fallbackKey": "initial_default",
      "uvVariables": ["project", "requirements_label", "review_label"],
      "usesStdin": false,
      "description": "Initial prompt for review task with project context",
      "condition": "args.project !== undefined",
      "priority": 5,
      "structuredGate": {
        "allowedIntents": ["next", "repeat", "complete"],
        "intentField": "next_action.action",
        "fallbackIntent": "next",
        "handoffFields": ["review.summary", "review.issues_found"]
      },
      "transitions": {
        "next": { "target": "continuation.default" },
        "repeat": { "target": "initial.default" },
        "complete": { "target": "complete.review" }
      }
    },
    "continuation.default": {
      "stepId": "continuation.default",
      "name": "Continuation Review Prompt",
      "c2": "continuation",
      "c3": "default",
      "edition": "default",
      "fallbackKey": "continuation_default",
      "uvVariables": ["iteration"],
      "usesStdin": false,
      "description": "Continuation prompt for subsequent review iterations",
      "structuredGate": {
        "allowedIntents": ["next", "repeat", "complete"],
        "intentField": "next_action.action",
        "fallbackIntent": "next",
        "handoffFields": ["review.progress", "review.remaining_items"]
      },
      "transitions": {
        "next": { "target": "continuation.default" },
        "repeat": { "target": "continuation.default" },
        "complete": { "target": "complete.review" }
      }
    }
  }
}
