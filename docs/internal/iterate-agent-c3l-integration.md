# Iterate Agent C3L Integration Design

> Design Date: 2026-01-01 Status: Final

---

## 1. Design Overview

### 1.1 Purpose

Integrate iterate-agent's prompt management into climpt's C3L framework,
managing it as an independent hierarchy under `.agent/iterator/`.

### 1.2 Design Principles

| Principle                   | Description                                                                    |
| --------------------------- | ------------------------------------------------------------------------------ |
| **Utilize climpt features** | Use existing climpt features for registry.json generation and prompt expansion |
| **Hierarchy separation**    | `.agent/climpt/` and `.agent/iterator/` are independent                        |
| **C3L compliance**          | Follow `iterator-dev start <mode>` naming convention                           |

---

## 2. Architecture

### 2.1 Component Relationship Diagram

```mermaid
graph TB
    subgraph "climpt framework"
        direction TB
        REG["/reg endpoint<br/>registry.json generation"]
        CLI["climpt CLI<br/>prompt expansion"]
        MCP["MCP Server<br/>command search"]
    end

    subgraph ".agent/climpt/"
        C_PROMPT["prompts/<br/>git/, meta/, test/"]
        C_REG["registry.json"]
        C_CONFIG["config/registry_config.json"]
    end

    subgraph ".agent/iterator/"
        I_PROMPT["prompts/<br/>dev/start/"]
        I_REG["registry.json"]
    end

    subgraph "Execution"
        IA["iterate-agent"]
        SKILL["delegate-climpt-agent"]
    end

    REG -->|"generate"| C_REG
    REG -->|"generate"| I_REG
    CLI -->|"read"| C_PROMPT
    CLI -->|"read"| I_PROMPT
    MCP -->|"reference"| C_CONFIG
    C_CONFIG -->|"climpt"| C_REG
    C_CONFIG -->|"iterator"| I_REG

    IA -->|"get system prompt"| CLI
    IA -->|"task delegation"| SKILL
    SKILL -->|"command search"| MCP
```

### 2.2 Hierarchy Separation Confirmation

| Item         | `.agent/climpt/`          | `.agent/iterator/`     |
| ------------ | ------------------------- | ---------------------- |
| Purpose      | General development tasks | iterate-agent specific |
| C3L Agent    | `climpt`                  | `iterator`             |
| c1 examples  | `git`, `meta`, `test`     | `dev`                  |
| Users        | delegate-climpt-agent     | iterate-agent startup  |
| Independence | Existing (no changes)     | Newly added            |

---

## 3. Directory Structure

```
.agent/
├── climpt/                               # Existing (partial changes)
│   ├── config/
│   │   ├── git-app.yml
│   │   ├── meta-app.yml
│   │   ├── iterator-dev-app.yml          # ← iterator config added
│   │   └── registry_config.json          # ← iterator entry added
│   ├── frontmatter-to-schema/
│   │   ├── registry.schema.json
│   │   ├── command.schema.json
│   │   └── registry.template.json
│   ├── prompts/
│   │   ├── git/
│   │   ├── meta/
│   │   └── test/
│   └── registry.json
│
└── iterator/                             # Newly created
    ├── frontmatter-to-schema/            # Copied from climpt
    │   ├── registry.schema.json
    │   ├── command.schema.json
    │   └── registry.template.json
    ├── prompts/
    │   └── dev/                          # c1 = dev
    │       └── start/                    # c2 = start
    │           ├── project/              # c3 = project
    │           │   └── f_default.md
    │           ├── issue/                # c3 = issue
    │           │   └── f_default.md
    │           └── default/              # c3 = default
    │               └── f_default.md
    └── registry.json                     # Generated by /reg
```

**Note**: iterator's config (`iterator-dev-app.yml`) is placed in
`.agent/climpt/config/`. This is because the breakdown library reads config from
this location.

---

## 4. C3L Naming Design

### 4.1 Command System

```
iterator-dev start project
    │     │    │     │
    │     │    │     └── c3: Target (project/issue/default)
    │     │    └── c2: Action (start)
    │     └── c1: Domain (dev)
    └── Agent: iterator
```

### 4.2 Mode Mapping

| iterate-agent option | C3L command                  |
| -------------------- | ---------------------------- |
| `--project 5`        | `iterator-dev start project` |
| `--issue 123`        | `iterator-dev start issue`   |
| (default)            | `iterator-dev start default` |

---

## 5. Call Chain

### 5.1 Overall Flow

```mermaid
sequenceDiagram
    autonumber
    participant User
    participant IA as iterate-agent
    participant CLI as climpt CLI
    participant Prompt as .agent/iterator/prompts/
    participant SDK as Claude Agent SDK
    participant Skill as delegate-climpt-agent
    participant MCP as MCP Server
    participant C_Prompt as .agent/climpt/prompts/

    User->>IA: deno run ... --project 5

    Note over IA,Prompt: Get system prompt (iterator hierarchy)
    IA->>CLI: iterator-dev start project
    CLI->>Prompt: read dev/start/project/f_default.md
    Prompt-->>CLI: template
    CLI-->>IA: processed prompt

    IA->>SDK: Claude.create(systemPrompt)

    loop Each Iteration
        Note over SDK,C_Prompt: Task execution (climpt hierarchy)
        SDK->>Skill: invoke delegate-climpt-agent
        Skill->>MCP: search --agent=climpt
        MCP-->>Skill: climpt-git create issue
        Skill->>CLI: climpt-git create issue
        CLI->>C_Prompt: read git/create/issue/f_default.md
        C_Prompt-->>CLI: prompt
        CLI-->>Skill: expanded prompt
        Skill->>SDK: run sub-agent
        SDK-->>IA: result
    end
```

### 5.2 Roles of Two Hierarchies

```mermaid
flowchart LR
    subgraph "iterate-agent startup"
        A[".agent/iterator/"]
        B["iterator-dev start *"]
        C["System prompt<br/>Initial/continuation prompt"]
    end

    subgraph "Task execution"
        D[".agent/climpt/"]
        E["climpt-git/meta/test *"]
        F["Development task prompts"]
    end

    A --> B --> C
    D --> E --> F

    C -->|"delegate-climpt-agent"| E
```

---

## 6. registry.json Management

### 6.1 Generation Flow

```mermaid
flowchart TD
    subgraph "For climpt"
        A1[".agent/climpt/prompts/**/*.md"]
        B1["/reg"]
        C1[".agent/climpt/registry.json"]
    end

    subgraph "For iterator"
        A2[".agent/iterator/prompts/**/*.md"]
        B2["/reg --input=... --output=..."]
        C2[".agent/iterator/registry.json"]
    end

    A1 --> B1 --> C1
    A2 --> B2 --> C2
```

### 6.2 Generation Commands

```bash
# For climpt (default)
deno run --allow-read --allow-write --allow-env jsr:@aidevtool/climpt/reg

# For iterator
deno run --allow-read --allow-write --allow-env jsr:@aidevtool/climpt/reg \
  --input=".agent/iterator/prompts/**/*.md" \
  --output=".agent/iterator/registry.json"
```

### 6.3 registry_config.json

```json
{
  "registries": {
    "climpt": ".agent/climpt/registry.json",
    "iterator": ".agent/iterator/registry.json"
  }
}
```

### 6.4 Resolution via --agent Parameter

```mermaid
flowchart LR
    subgraph "Input"
        A["--agent=climpt"]
        B["--agent=iterator"]
    end

    subgraph "registry_config.json"
        C["registries"]
    end

    subgraph "registry.json"
        D[".agent/climpt/registry.json"]
        E[".agent/iterator/registry.json"]
    end

    A --> C --> D
    B --> C --> E
```

---

## 7. Prompt File Design

### 7.1 Frontmatter Format

```yaml
---
c1: iterator-dev
c2: start
c3: project
title: Project Mode System Prompt
description: System prompt for GitHub Project iteration
usage: iterator-dev start project
c3l_version: "0.5"
options:
  edition: ["default"]
  adaptation: ["default"]
  file: false
  stdin: false
  destination: false
---
```

### 7.2 Template Variables

| Variable                         | Replacement Timing | Description                    |
| -------------------------------- | ------------------ | ------------------------------ |
| `{{AGENT}}`                      | iterate-agent      | Agent name                     |
| `{{COMPLETION_CRITERIA}}`        | iterate-agent      | Completion criteria (short)    |
| `{{COMPLETION_CRITERIA_DETAIL}}` | iterate-agent      | Completion criteria (detailed) |

### 7.3 Mode Differences

| Element            | project             | issue                 | default      |
| ------------------ | ------------------- | --------------------- | ------------ |
| Purpose            | Complete all Issues | Complete single Issue | N iterations |
| issue-action       | Required            | None                  | None         |
| GitHub integration | Project API         | Issue API             | None         |

---

## 8. Implementation Changes

### 8.1 File Change List

| File                                               | Change Content       |
| -------------------------------------------------- | -------------------- |
| `.agent/iterator/`                                 | Create new directory |
| `.agent/iterator/config/dev-app.yml`               | Create new           |
| `.agent/iterator/prompts/dev/start/*/f_default.md` | Create new (3 files) |
| `.agent/iterator/registry.json`                    | Generate with /reg   |
| `.agent/climpt/config/registry_config.json`        | Add iterator entry   |
| `agents/iterator/scripts/config.ts`                | Support C3L loading  |

### 8.2 config.ts Changes

```typescript
export async function loadSystemPromptViaC3L(
  mode: "project" | "issue" | "iterate",
): Promise<string> {
  const c3 = mode === "iterate" ? "default" : mode;

  const command = new Deno.Command("deno", {
    args: [
      "run",
      "--allow-read",
      "--allow-write",
      "--allow-env",
      "jsr:@aidevtool/climpt",
      "--config=iterator-dev",
      "start",
      c3,
    ],
  });

  const { stdout } = await command.output();
  return new TextDecoder().decode(stdout);
}
```

---

## 9. Consistency Verification

### 9.1 climpt Feature Utilization

| Feature               | Usage                             | Confirmation                                    |
| --------------------- | --------------------------------- | ----------------------------------------------- |
| `/reg`                | iterator registry.json generation | ✅ Supported with `--input`, `--output` options |
| CLI prompt expansion  | iterator-dev start *              | ✅ Supported with `--config=iterator-dev`       |
| registry_config.json  | --agent=iterator resolution       | ✅ Supported by adding iterator entry           |
| frontmatter-to-schema | registry.json generation          | ✅ Reuse existing schema                        |

### 9.2 Hierarchy Independence

| Verification Item | climpt                    | iterator         | Independence            |
| ----------------- | ------------------------- | ---------------- | ----------------------- |
| prompts/          | git/, meta/, test/        | dev/start/       | ✅ Separate directories |
| registry.json     | .agent/climpt/            | .agent/iterator/ | ✅ Separate files       |
| config/*.yml      | git-app.yml, meta-app.yml | dev-app.yml      | ✅ Separate files       |
| C3L Agent name    | climpt                    | iterator         | ✅ Different names      |

### 9.3 Data Flow Verification

```mermaid
flowchart TD
    subgraph "Design time"
        A["Create prompts"] --> B[".agent/iterator/prompts/"]
        B --> C["/reg --input=..."]
        C --> D[".agent/iterator/registry.json"]
        D --> E["Add to registry_config.json"]
    end

    subgraph "Runtime"
        F["iterate-agent --project 5"]
        F --> G["CompletionHandler.type = 'project'"]
        G --> H["loadSystemPromptViaC3L('project')"]
        H --> I["climpt --config=iterator-dev start project"]
        I --> J[".agent/iterator/prompts/dev/start/project/f_default.md"]
        J --> K["Template expansion"]
        K --> L["System prompt"]
    end

    E -.-> F
```

---

## 10. References

- [Iterate Agent Design Specification](./iterate-agent-design.md) - Overall
  iterate-agent design
- [C3L Specification v0.5](../c3l_specification_v0.5.md)
- [Iterate Agent README](../../agents/iterator/README.md)
- [Climpt README](../../README.md)
- [delegate-climpt-agent SKILL.md](../../plugins/climpt-agent/skills/delegate-climpt-agent/SKILL.md)
