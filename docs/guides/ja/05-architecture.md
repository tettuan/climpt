[English](../en/05-architecture.md) | [日本語](../ja/05-architecture.md)

# 5. Climpt 全体像

Climpt の基本概念、アーキテクチャ、コマンド実行の流れを説明します。

## 目次

1. [Climpt とは何か](#51-climpt-とは何か)
2. [アーキテクチャ概要](#52-アーキテクチャ概要)
3. [5層構造](#53-5層構造)
4. [コマンド実行の流れ](#54-コマンド実行の流れ)

---

## 5.1 Climpt とは何か

### 基本概念

Climpt は「CLI + Prompt = Climpt」という命名の通り、**CLI でプロンプトを呼び出すツール**です。

```
┌─────────────────────────────────────────────────────────────┐
│                      Climpt の役割                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   入力                    Climpt                   出力     │
│  ┌──────┐              ┌──────────┐              ┌──────┐  │
│  │ 引数 │─────────────▶│ テンプレ │─────────────▶│プロン│  │
│  │ STDIN│              │ ート置換 │              │ プト │  │
│  │ ファイル│            └──────────┘              └──────┘  │
│  └──────┘                   │                              │
│                             │                              │
│                    ┌────────▼────────┐                     │
│                    │ プロンプト      │                     │
│                    │ ファイル群      │                     │
│                    │ (.md テンプレート)│                    │
│                    └─────────────────┘                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 何をするツールか

| 機能 | 説明 |
|------|------|
| プロンプトの一元管理 | 事前に用意したプロンプト群を整理・保存 |
| 1行での呼び出し | `climpt-git create branch` のようなコマンドで即座に取得 |
| 動的な値の差し込み | 引数や標準入力で変数を置換 |
| AI との連携 | MCP サーバーを通じて Claude などの AI がプロンプトを選択・実行 |

### C3L（Climpt 3-word Language）

Climpt のコマンドは3つの要素で構成されます：

| 要素 | 役割 | 例 |
|------|------|-----|
| c1（ドメイン） | 対象領域 | `git`, `code`, `meta` |
| c2（アクション） | 実行する動作 | `create`, `analyze`, `review` |
| c3（ターゲット） | 対象物 | `branch`, `pull-request`, `instruction` |

コマンド形式：
```
climpt-<c1> <c2> <c3> [options]
```

実行例：
```bash
climpt-git decide-branch working-branch
climpt-meta create instruction
climpt-code review pull-request
```

---

## 5.2 アーキテクチャ概要

### コンポーネント構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Climpt アーキテクチャ                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                     ユーザー入力                       │ │
│  │  CLI コマンド / MCP Tool Call / Claude Code Plugin   │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│            ┌───────────────┼───────────────┐               │
│            │               │               │               │
│            ▼               ▼               ▼               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │    CLI      │  │    MCP      │  │   Plugin    │        │
│  │  Interface  │  │   Server    │  │  (Claude)   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│            │               │               │               │
│            └───────────────┼───────────────┘               │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                    Core Engine                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │   Config    │  │   Prompt    │  │  Template   │   │ │
│  │  │   Loader    │  │   Loader    │  │   Engine    │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                   ファイルシステム                     │ │
│  │  .agent/climpt/config/    .agent/climpt/prompts/     │ │
│  │  .agent/climpt/registry.json                          │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 各コンポーネントの役割

| コンポーネント | 役割 |
|---------------|------|
| CLI Interface | コマンドライン引数を解析し、Core Engine を呼び出す |
| MCP Server | AI アシスタントからのツール呼び出しを処理 |
| Plugin | Claude Code との統合 |
| Config Loader | 設定ファイル（app.yml, user.yml）を読み込む |
| Prompt Loader | プロンプトファイル（.md）を読み込む |
| Template Engine | テンプレート変数を置換 |

### breakdown パッケージとの関係

Climpt は内部で `@tettuan/breakdown` パッケージを使用しています：

```
┌─────────────────────────────────────────────────────────────┐
│                        Climpt                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   CLI Interface                      │   │
│  │  climpt-git, climpt-meta, climpt-code ...           │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              @tettuan/breakdown                      │   │
│  │  - ファイル読み込み                                 │   │
│  │  - テンプレート変数置換                             │   │
│  │  - 設定ファイル解析                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

breakdown パッケージが提供する機能：
- YAML 設定ファイルの解析
- Markdown プロンプトファイルの読み込み
- テンプレート変数（`{input_text}` など）の置換

---

## 5.3 5層構造

Climpt は段階的に進化し、現在は5つの層から構成されています。

### 層の全体像

```
┌─────────────────────────────────────────────────────────────┐
│                        Agent 層（自律実行）                   │
├─────────────────────────────────────────────────────────────┤
│  [最上位層] Iterator/Reviewer Agent                          │
│       │    Claude Agent SDK で GitHub Issue/Project と連携  │
│       ▼                                                      │
│  [中間層] delegate-climpt-agent Skill                        │
│       │    Claude Code Plugin。コマンド検索、オプション解決   │
│       ▼                                                      │
│  [実行層] climpt-agent.ts (Sub-Agent)                        │
│           Claude Agent SDK で自律実行                         │
├─────────────────────────────────────────────────────────────┤
│                        環境層（基盤）                        │
├─────────────────────────────────────────────────────────────┤
│  [ツール層] CLI / MCP                                        │
│       │    プロンプト取得のインターフェース                   │
│       ▼                                                      │
│  [設定層] registry.json / prompts/                           │
│           @tettuan/breakdown によるテンプレート変換           │
└─────────────────────────────────────────────────────────────┘
```

### 各層の役割

| 層 | 役割 | コンテクスト | 実体 |
|----|------|-------------|------|
| 最上位層 | GitHub連携、反復制御 | SDK Session #1 | `agents/iterator/scripts/agent.ts` |
| 中間層 | パラメータ変換、コマンド解決 | Plugin Context | `plugins/climpt-agent/skills/delegate-climpt-agent/SKILL.md` |
| 実行層 | プロンプト取得、自律実行 | SDK Session #2 | `plugins/climpt-agent/skills/delegate-climpt-agent/scripts/climpt-agent.ts` |
| ツール層 | CLI/MCP による呼び出し | CLI/MCP Process | `cli.ts`, `mcp.ts` |
| 設定層 | プロンプトテンプレート | File System | `.agent/climpt/` |

### 三層連鎖（Agent 層内部）

Agent 層は3つの層が連鎖し、**コンテクスト分離**によって柔軟な自律動作を実現します。

```
┌─────────────────────────────────────────────────────────────┐
│                      三層連鎖の構造                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [最上位層] Iterator Agent                                  │
│             Claude Agent SDK Session #1                     │
│             └── GitHub との接続、反復制御                   │
│                        │                                    │
│                        │ Skill 呼び出し                     │
│                        ▼                                    │
│  [中間層] delegate-climpt-agent Skill                       │
│           Claude Code Plugin Context                        │
│           └── パラメータ変換、コマンド解決                   │
│                        │                                    │
│                        │ TypeScript 起動                    │
│                        ▼                                    │
│  [実行層] climpt-agent.ts (Sub-Agent)                       │
│           Claude Agent SDK Session #2                       │
│           └── プロンプト取得、自律実行                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**ポイント**:
- 最上位層と実行層は**別々の SDK セッション**で動作
- 中間層が**橋渡し**となり、パラメータ変換や検索を担当
- 各層のコンテクストが分離されているため、責務が明確

### 呼び出しの入口

| 用途 | エントリポイント |
|------|-----------------|
| CLI 実行 | `jsr:@aidevtool/climpt/cli` |
| MCP サーバー | `jsr:@aidevtool/climpt/mcp` |
| Iterator Agent | `jsr:@aidevtool/climpt/agents/iterator` |
| Reviewer Agent | `jsr:@aidevtool/climpt/agents/reviewer` |

---

## 5.4 コマンド実行の流れ

### 実行例

```bash
echo "バグ修正の実装" | climpt-git decide-branch working-branch -o=./output/
```

### 処理フロー（5ステップ）

```
Step 1: コマンド解析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  climpt-git decide-branch working-branch -o=./output/
     │         │              │              │
     │         │              │              └─ destination: ./output/
     │         │              └─ c3 (target): working-branch
     │         └─ c2 (action): decide-branch
     └─ c1 (domain): git (--config=git)

Step 2: 設定ファイル読み込み
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  .agent/climpt/config/git-app.yml
    └─ working_dir: ".agent/climpt"
    └─ app_prompt.base_dir: "prompts/git"

Step 3: プロンプトファイル特定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  パス構築:
    base_dir + c2 + c3 + filename
    = prompts/git/decide-branch/working-branch/f_default.md

  edition/adaptation による選択:
    --edition=bug --adaptation=detailed
    → f_bug_detailed.md を探す
    → なければ f_bug.md
    → なければ f_default.md

Step 4: テンプレート変数の置換
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  プロンプト内:
    {input_text}        → "バグ修正の実装" (STDIN)
    {destination_path}  → "./output/"

Step 5: 結果出力
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  置換済みプロンプトを標準出力へ
```

### フローチャート

```
┌──────────────────┐
│ コマンド実行     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 引数解析         │
│ c1, c2, c3,      │
│ options          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌────────────────────────┐
│ 設定ファイル     │────▶│ .agent/climpt/config/  │
│ 読み込み         │     │ {c1}-app.yml           │
└────────┬─────────┘     └────────────────────────┘
         │
         ▼
┌──────────────────┐     ┌────────────────────────┐
│ プロンプトファイル│────▶│ prompts/{c1}/{c2}/{c3}/│
│ 特定・読み込み   │     │ f_{edition}.md         │
└────────┬─────────┘     └────────────────────────┘
         │
         ▼
┌──────────────────┐
│ STDIN 読み込み   │ (stdin オプション時)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ テンプレート     │
│ 変数置換         │
│ {input_text} →値 │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 結果出力         │
│ (STDOUT)         │
└──────────────────┘
```

---

## 関連ガイド

- [06-config-files.md](./06-config-files.md) - 設定ファイル編
- [07-dependencies.md](./07-dependencies.md) - 依存構造編（レジストリ、MCP）
- [08-prompt-structure.md](./08-prompt-structure.md) - プロンプト構造編
