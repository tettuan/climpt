# 7. 依存構造編

Climpt のレジストリ、MCP サーバー、外部パッケージとの依存関係を説明します。

## 目次

1. [パッケージ依存関係](#71-パッケージ依存関係)
2. [レジストリの仕組み](#72-レジストリの仕組み)
3. [レジストリの生成](#73-レジストリの生成)
4. [MCP サーバーの動作](#74-mcp-サーバーの動作)
5. [Claude Code プラグインとの連携](#75-claude-code-プラグインとの連携)

---

## 7.1 パッケージ依存関係

### 依存構造図

```
┌─────────────────────────────────────────────────────────────┐
│                    Climpt パッケージ構造                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │          jsr:@aidevtool/climpt                        │ │
│  │                                                       │ │
│  │  エントリポイント:                                    │ │
│  │  - /cli      → CLI 実行                              │ │
│  │  - /mcp      → MCP サーバー                          │ │
│  │  - /reg      → レジストリ生成                        │ │
│  │  - /agents/iterator → Iterate Agent                  │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │          jsr:@tettuan/breakdown                       │ │
│  │                                                       │ │
│  │  機能:                                                │ │
│  │  - YAML 設定ファイル解析                             │ │
│  │  - プロンプトファイル読み込み                        │ │
│  │  - テンプレート変数置換                              │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │       jsr:@aidevtool/frontmatter-to-schema           │ │
│  │                                                       │ │
│  │  機能:                                                │ │
│  │  - フロントマターからレジストリ生成                  │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 主要パッケージ

| パッケージ | 役割 | JSR URL |
|-----------|------|---------|
| `@aidevtool/climpt` | メインパッケージ | `jsr:@aidevtool/climpt` |
| `@tettuan/breakdown` | コア機能（テンプレート処理） | `jsr:@tettuan/breakdown` |
| `@aidevtool/frontmatter-to-schema` | レジストリ生成 | `jsr:@aidevtool/frontmatter-to-schema` |

---

## 7.2 レジストリの仕組み

### registry.json の役割

レジストリは、利用可能なすべてのコマンドとそのメタデータを保持するファイルです。

```json
{
  "version": "1.0.0",
  "description": "Climpt command registry",
  "tools": {
    "availableConfigs": ["git", "meta", "code"],
    "commands": [
      {
        "c1": "git",
        "c2": "decide-branch",
        "c3": "working-branch",
        "description": "Decide branch strategy based on task",
        "usage": "climpt-git decide-branch working-branch",
        "options": {
          "edition": ["default"],
          "adaptation": ["default"],
          "file": false,
          "stdin": true,
          "destination": false
        }
      }
    ]
  }
}
```

### レジストリの用途

| 用途 | 説明 |
|------|------|
| MCP サーバー | 利用可能なツールを AI に通知 |
| CLI ヘルプ | `--help` でオプション情報を表示 |
| バリデーション | 無効なコマンドの検出 |
| コマンド検索 | キーワードによるコマンド検索 |

### レジストリのスキーマ

```typescript
interface Registry {
  version: string;           // レジストリバージョン
  description: string;       // 説明
  tools: {
    availableConfigs: string[];  // 利用可能なドメイン
    commands: Command[];         // コマンド定義
  };
}

interface Command {
  c1: string;          // ドメイン
  c2: string;          // アクション
  c3: string;          // ターゲット
  description: string; // コマンド説明
  usage: string;       // 使用例
  options: {
    edition: string[];     // エディション一覧
    adaptation: string[];  // 処理モード一覧
    file: boolean;         // ファイル入力対応
    stdin: boolean;        // STDIN 対応
    destination: boolean;  // 出力先指定対応
  };
  uv?: Array<{[key: string]: string}>;  // ユーザー変数
}
```

---

## 7.3 レジストリの生成

### 生成フロー

```
┌─────────────────────────────────────────────────────────────┐
│                  レジストリ生成フロー                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1: プロンプトファイルをスキャン                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ .agent/climpt/prompts/**/*.md                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  Step 2: フロントマターを抽出                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ---                                                 │   │
│  │ c1: git                                             │   │
│  │ c2: decide-branch                                   │   │
│  │ c3: working-branch                                  │   │
│  │ description: ...                                    │   │
│  │ options: ...                                        │   │
│  │ ---                                                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  Step 3: スキーマに従って変換                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ registry.schema.json を使用                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  Step 4: registry.json を出力                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ .agent/climpt/registry.json                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 生成コマンド

```bash
# Claude Code 内
/reg

# Deno Task
deno task generate-registry

# JSR 直接実行
deno run --allow-read --allow-write --allow-env jsr:@aidevtool/climpt/reg
```

### オプション

```bash
deno run jsr:@aidevtool/climpt/reg \
  --base=.agent/climpt \
  --input="prompts/**/*.md" \
  --output=registry.json \
  --template=registry.schema.json
```

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `--base` | ベースディレクトリ | `.agent/climpt` |
| `--input` | 入力 glob パターン | `prompts/**/*.md` |
| `--output` | 出力ファイル | `registry.json` |
| `--template` | スキーマファイル | (内蔵) |

---

## 7.4 MCP サーバーの動作

### MCP とは

MCP（Model Context Protocol）は、AI アシスタントが外部ツールと対話するための標準プロトコルです。

### Climpt MCP サーバーの構成

```
┌─────────────────────────────────────────────────────────────┐
│                    MCP サーバー動作                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Claude / AI アシスタント             │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│                     MCP プロトコル                          │
│                            │                                │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  Climpt MCP Server                    │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │                    Tools                        │ │ │
│  │  │  - search: コマンド検索                         │ │ │
│  │  │  - describe: コマンド詳細取得                   │ │ │
│  │  │  - execute: コマンド実行                        │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                         │                            │ │
│  │                         ▼                            │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │              Registry Manager                   │ │ │
│  │  │  registry_config.json から読み込み             │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │              .agent/climpt/registry.json              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### MCP ツール一覧

| ツール | 機能 | パラメータ |
|--------|------|----------|
| `search` | キーワードでコマンド検索 | `query`, `agent?` |
| `describe` | コマンド詳細取得 | `c1`, `c2`, `c3`, `agent?` |
| `execute` | コマンド実行 | `c1`, `c2`, `c3`, `stdin?`, `options?` |

### 使用例

```javascript
// コマンド検索
search({ query: "branch" })

// コマンド詳細取得
describe({
  c1: "git",
  c2: "decide-branch",
  c3: "working-branch"
})

// コマンド実行
execute({
  c1: "git",
  c2: "decide-branch",
  c3: "working-branch",
  stdin: "バグ修正の実装"
})

// 別エージェントのコマンド検索
search({ query: "analyze", agent: "inspector" })
```

### MCP 設定

```json
// .mcp.json または ~/.claude.json
{
  "mcpServers": {
    "climpt": {
      "command": "deno",
      "args": [
        "run",
        "--allow-read",
        "--allow-write",
        "--allow-net",
        "--allow-env",
        "--allow-run",
        "jsr:@aidevtool/climpt/mcp"
      ]
    }
  }
}
```

---

## 7.5 Claude Code プラグインとの連携

### 連携構造

```
┌─────────────────────────────────────────────────────────────┐
│                 Claude Code プラグイン連携                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                    Claude Code                        │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │            climpt-agent プラグイン              │ │ │
│  │  │  - delegate-climpt-agent Skill                  │ │ │
│  │  │  - /climpt コマンド                             │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
│                            │                                │
│            ┌───────────────┼───────────────┐               │
│            │               │               │               │
│            ▼               ▼               ▼               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Skill     │  │    MCP      │  │  Iterate    │        │
│  │   呼び出し  │  │   Server    │  │   Agent     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│            │               │               │               │
│            └───────────────┼───────────────┘               │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐ │
│  │              Climpt コア機能                          │ │
│  │  - コマンド実行                                       │ │
│  │  - プロンプト生成                                     │ │
│  │  - レジストリ管理                                     │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### プラグインが提供する機能

| 機能 | 説明 |
|------|------|
| `delegate-climpt-agent` Skill | Climpt エージェントにタスクを委任 |
| 自然言語コマンド | 自然言語から適切なコマンドを検索・実行 |
| Git ワークフロー | コミットグループ化、ブランチ管理 |

### Skill 呼び出し例

```
Climpt を使って、現在の変更をコミットしてください。
→ delegate-climpt-agent Skill が呼び出される
→ group-commit unstaged-changes が実行される
```

---

## データフロー全体像

```
┌─────────────────────────────────────────────────────────────┐
│                      データフロー                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [ユーザー/AI]                                              │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────────┐                                       │
│  │ CLI / MCP /     │                                       │
│  │ Plugin          │                                       │
│  └────────┬────────┘                                       │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐     ┌─────────────────┐              │
│  │ registry.json   │────▶│ コマンド特定    │              │
│  └─────────────────┘     └────────┬────────┘              │
│                                   │                         │
│                                   ▼                         │
│  ┌─────────────────┐     ┌─────────────────┐              │
│  │ app.yml         │────▶│ パス解決        │              │
│  └─────────────────┘     └────────┬────────┘              │
│                                   │                         │
│                                   ▼                         │
│  ┌─────────────────┐     ┌─────────────────┐              │
│  │ f_default.md    │────▶│ テンプレート    │              │
│  │ (プロンプト)    │     │ 変数置換        │              │
│  └─────────────────┘     └────────┬────────┘              │
│                                   │                         │
│                                   ▼                         │
│                          ┌─────────────────┐              │
│                          │ プロンプト出力  │              │
│                          └─────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 関連ガイド

- [05-architecture.md](./05-architecture.md) - 全体像編
- [06-config-files.md](./06-config-files.md) - 設定ファイル編
- [08-prompt-structure.md](./08-prompt-structure.md) - プロンプト構造編
